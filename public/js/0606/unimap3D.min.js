// version:1.0        author:sunzq        Email:zengqiang365@163.com
function initViewer(P,Z,wa,t){function xa(){for(var a=[],b=0;15>b;b++)a.push("/data/gmp/gmp-level"+b+".json");var a=Promise.map(a,function(a,b){return Cesium.loadJson(a).then(function(a){aa[b]=a[0].data;return aa})}),b=Cesium.loadJson("/data/coordinate/lat.json").then(function(a){A=a.XLAT;return G=_.chunk(A,194)}),d=Cesium.loadJson("/data/coordinate/long.json").then(function(a){H=a.XLONG;return B=_.chunk(H,194)});return Promise.all([b,d,a])}function ja(a){for(var b=0;b<a;b++){var d=new Cesium.CustomDataSource("level-"+b);e.dataSources.add(d)}}function ba(){var a=[];e.dataSources._dataSources.forEach(function(b){0==b.name.indexOf("level")&&a.push(b)});return a}function ka(){ba().forEach(function(a){e.dataSources.remove(a)})}function la(){I=new Cesium.CustomDataSource("pblh");e.dataSources.add(I);I.show=Q;var a=l.time.utc().format("YYYY-MM-DD_HH")+"-";Cesium.loadJson(l.dataServerAddr+"/data/pollute/2015052506/pblh/"+a+"PBLH.json").then(function(a){a=a[0].data;for(var b=I.entities,g=0;g<a.length-194;g++)if(0!=(g-193)%194){var h=100*a[g];b.add({rectangle:{coordinates:Cesium.Rectangle.fromDegrees(H[g],A[g],H[g+195],A[g+195]),height:h,material:Cesium.Color.NAVY.withAlpha(.2)}})}}).otherwise(function(a){console.log(a)})}function ca(){var a=colortable.getColorScale(l.color);if(a){var b=p.valueRange.min,d=p.valueRange.max;return function(g){var h=a((g-b)/(d-b)),h=new Cesium.Color.fromCssColorString(h);g=p.alphaScale(g);return new Cesium.Color.fromAlpha(h,g)}}return function(a){return p.color(a)}}function ya(a){var b,d="level-"+a;e.dataSources._dataSources.forEach(function(a){d==a.name&&(b=a)});return b}function R(){ka();ja(p.levelNum);ma()}function na(){"streetMap"!=l.mapType&&(l.mapType="streetMap",e.terrainProvider=new Cesium.EllipsoidTerrainProvider,C.remove(satelliteLayer,!1),C.add(streetLayer),l.realHeight=!1)}function oa(a){Cesium.loadJson("/data/"+("22"==a?"jjjstation.json":"nmgstation.json")).then(function(a){a=a.data;var b=v.entities;new Cesium.PinBuilder;b.suspendEvents();a.forEach(function(a){var d=da(a.aqi),d=new Cesium.Color.fromCssColorString(d);(entity=b.getById(a.id))?_.extend(entity,{value:a,billboard:{color:d,image:"/images/square.png",verticalOrigin:Cesium.VerticalOrigin.CENTER}}):b.add({id:a.id,name:a.name,value:a,type:"station",position:Cesium.Cartesian3.fromDegrees(a.longitude,a.latitude),billboard:{color:d,image:"/images/square.png",verticalOrigin:Cesium.VerticalOrigin.CENTER}})});b.resumeEvents()}).otherwise(function(a){window.alert(a)})}function za(){z.entities.removeAll();D.entities.removeAll();Cesium.loadJson("/data/cityspol.json").then(function(a){pa=a.data;var b=z.entities,d=new Cesium.PinBuilder;b.suspendEvents();pa.forEach(function(a){var h=da(a.aqi),h=new Cesium.Color.fromCssColorString(h);b.add({id:a.cityid,name:a.cityname,value:a,type:"city",position:Cesium.Cartesian3.fromDegrees(a.lon,a.lat),billboard:{image:d.fromText(a.aqi,h,48).toDataURL(),verticalOrigin:Cesium.VerticalOrigin.BOTTOM}})});b.resumeEvents()}).otherwise(function(a){window.alert(a)});Cesium.loadJson("/data/citypol.json").then(function(a){qa=a.data;var b=D.entities,d=new Cesium.PinBuilder;b.suspendEvents();qa.forEach(function(a){var h=da(a.aqi),h=new Cesium.Color.fromCssColorString(h);b.add({id:a.cityid,name:a.cityname,value:a,type:"city",position:Cesium.Cartesian3.fromDegrees(a.lon,a.lat),billboard:{image:d.fromText(a.aqi,h,48).toDataURL(),verticalOrigin:Cesium.VerticalOrigin.BOTTOM}})});b.resumeEvents()}).otherwise(function(a){window.alert(a)})}function Aa(a){a=e.scene.drillPick(a.position);if(0==a.length||1==a.length&&"selector"==a[0].id.type)w&&_.extend(w.polygon,{material:Cesium.Color.fromAlpha(Cesium.Color.packedLength,.01)});else if(1==a.length&&"province"==a[0].id.type){if(w&&_.extend(w.polygon,{material:Cesium.Color.fromAlpha(Cesium.Color.packedLength,.01)}),Cesium.defined(a[0])&&(w=a[0].id,_.extend(w.polygon,{material:Cesium.Color.fromAlpha(Cesium.Color.MEDIUMSPRINGGREEN,.3)}),!w.stationLoded)){var b={"\u4f18":0,"\u826f":0,"\u8f7b\u5ea6":0,"\u4e2d\u5ea6":0,"\u91cd\u5ea6":0,"\u4e25\u91cd":0};Cesium.loadJson("/data/"+("22"==w.name?"jjjstation.json":"nmgstation.json")).then(function(a){a.data.forEach(function(a){50>=a.aqi?b["\u4f18"]++:100>=a.aqi?b["\u826f"]++:200>=a.aqi?b["\u8f7b\u5ea6"]++:300>=a.aqi?b["\u4e2d\u5ea6"]++:500>=a.aqi?b["\u91cd\u5ea6"]++:b["\u4e25\u91cd"]++})}).then(function(){E.updateALFigure(b)})}}else{var d;if(1==a.length)d=a[0].id;else for(var g=0;g<a.length;g++)if("province"!=a[g].id.type&&"selector"!=a[g].id.type){d=a[g].id;break}d&&(d.description={getValue:function(){var a=d.value,b={ID:a.id,"\u540d\u79f0":a.name,AQI:a.aqi,"\u6c61\u67d3\u7b49\u7ea7":a.airqualitylevel,"\u4e3b\u8981\u6c61\u67d3\u7269":a.primarypollutant,"PM2.5":a.pm25,PM10:a.pm10,SO2:a.so2,NO2:a.no2,CO:a.co,O3:a.o3};"city"!=d.type&&(b["\u540d\u79f0"]=a.sitename);var a='\x3ctable class\x3d"cesium-infoBox-defaultTable"\x3e\x3ctbody\x3e',g;for(g in b)a+="\x3ctr\x3e\x3cth\x3e"+g+"\x3c/th\x3e\x3ctd\x3e"+b[g]+"\x3c/td\x3e\x3c/tr\x3e";return a+"\x3c/tbody\x3e\x3c/table\x3e"}},e.selectedEntity=d,"station"==d.type&&Cesium.loadJson("/data/24h/"+d.value.id+".json").then(function(a){E.updateSTFigure(a.data)}))}}function ea(){w=null;T.entities.values.forEach(function(a){_.extend(a.polygon,{material:Cesium.Color.fromAlpha(Cesium.Color.packedLength,.01)})})}function Ba(a){a=e.scene.pick(a.endPosition);Cesium.defined(a)&&"province"==a.id.type&&a.id.name!=U&&(U=a.id.name,2E5>V&&oa(U))}function Ca(a){var b={"\u4f18":0,"\u826f":0,"\u8f7b\u5ea6":0,"\u4e2d\u5ea6":0,"\u91cd\u5ea6":0,"\u4e25\u91cd":0};a.forEach(function(a){50>=a.value.aqi?b["\u4f18"]++:100>=a.value.aqi?b["\u826f"]++:200>=a.value.aqi?b["\u8f7b\u5ea6"]++:300>=a.value.aqi?b["\u4e2d\u5ea6"]++:500>=a.value.aqi?b["\u91cd\u5ea6"]++:b["\u4e25\u91cd"]++});return b}function Da(a){var b=[];z.entities.values.forEach(function(d){var g=Cesium.Cartographic.fromCartesian(d.position._value),e=g.latitude,g=g.longitude;g<=a.east&&g>=a.west&&e>=a.south&&e<=a.north&&b.push(d)});return b}function Ea(){Cesium.GeoJsonDataSource.load("/data/citys.cut.topo.json").then(function(a){q&&e.dataSources.contains(q)&&e.dataSources.remove(q);q=a;e.dataSources.add(q);a=q.entities.values;for(var b=0;b<a.length;b++){var d=a[b],g=Fa(d.properties.DN/200),g=new Cesium.Color.fromCssColorString(g),g=Cesium.Color.fromAlpha(g,.8);d.polygon.material=g;d.polygon.outline=!1}})}function Ga(){d3.json("/data/current(10-60)-temp-surface-surface-gfs-1.0.json",function(a,b){if(a)console.log(a);else{var d=function(a,b){var c=(a-p)/x,d=(Ha-b)/t,f=Math.floor(c),g=f+1,e=Math.floor(d),h;if(h=m[e]){var k=h[f],r=h[g];if(null!==k&&void 0!==k&&null!==r&&void 0!==r&&(h=m[e+1])){var n=h[f],g=h[g];if(null!==n&&void 0!==n&&null!==g&&void 0!==g)return c-=f,d-=e,e=1-c,f=1-d,k*e*f+r*c*f+n*e*d+g*c*d}}return null},g=function(a,b,c){a=4*(b*F+a);n.data[a]=c[0];n.data[a+1]=c[1];n.data[a+2]=c[2];n.data[a+3]=c[3]},h=b[0],f=h.header,S=Math.min(f.lo1,f.lo2),l=Math.min(f.la1,f.la2),r=Math.max(f.lo1,f.lo2),k=Math.max(f.la1,f.la2),F=(r-S)/(k-l)*500,c=document.createElement("canvas");c.width=F;c.height=500;for(var u=c.getContext("2d"),S=d3.scale.linear().domain([0,F]).range([S,r]),l=d3.scale.linear().domain([0,500]).range([k,l]),n=u.getImageData(0,0,F,500),p=f.lo1,Ha=Math.max(f.la1,f.la2),x=f.dx,t=f.dy,r=f.nx,m=[],q=0,f=f.ny-1;0<=f;f--){for(var y=[],k=0;k<r;k++,q++)y[k]=h.data[q];m[f]=y}h=d3.scale.linear().domain([193,206,219,233.15,255.372,273.15,275.15,291,298,311,328]).range("#25042a #290a82 #512828 #c02595 #46d7d7 #1554bb #18840e #f7fb3b #eba715 #e64727 #581b43".split(" "));for(f=0;500>f;f++)for(k=0;k<F;k++)r=S(k),q=l(f),r=d(r,q),r=d3.rgb(h(r)),g(k,f,[r.r,r.g,r.b,150]);u.putImageData(n,0,0);for(k=0;500>k;k+=50)u.fillRect(0,k,50,5);J=e.entities.add({rectangle:{coordinates:Cesium.Rectangle.fromDegrees(60,10,150,60),height:1E5,material:new Cesium.ImageMaterialProperty({image:c,color:Cesium.Color.fromBytes(255,255,255,Cesium.Color.floatToByte(.99))})}});_.extend(J.rectangle.material.image,{_value:c.toDataURL()})}});d3.json("/data/current-wind-surface-level-gfs-1.0.json",function(a,b){if(a)console.log(a);else{var d=function(){v.clearRect(0,0,q,x);C.forEach(function(a,b){0<a.length&&(v.beginPath(),v.strokeStyle=B[b],a.forEach(function(a){v.moveTo(a.x,a.y);v.lineTo(a.xt,a.yt);a.x=a.xt;a.y=a.yt}),v.stroke())})},g=function(){C.forEach(function(a){a.length=0});K.forEach(function(a){a.age>p&&(J(a).age=0);var b=a.x,c=a.y,d=h(b,c),f=d[2];null===f?a.age=p:(b+=d[0],c-=d[1],null!==h(b,c)[2]?(a.xt=b,a.yt=c,C[B.indexFor(f)].push(a)):(a.x=b,a.y=c));a.age+=1})},h=function(a,b){var c=H[Math.round(b)];return c&&c[Math.round(a)]||r},f=function(a,b){var c=y(a),d=z(b);a:{var f=(c-D)/I,g=(E-d)/L,e=Math.floor(f),x=e+1,h=Math.floor(g),k=h+1,n;if(n=A[h])if(d=n[e],c=n[x],l(d)&&l(c)&&(n=A[k])&&(k=n[e],x=n[x],l(k)&&l(x))){f-=e;e=g-h;n=1-f;h=1-e;g=n*h;h*=f;n*=e;e*=f;f=d[0]*g+c[0]*h+k[0]*n+x[0]*e;d=d[1]*g+c[1]*h+k[1]*n+x[1]*e;d=[f,d,Math.sqrt(f*f+d*d)];break a}d=r}return d},l=function(a){return null!==a&&void 0!==a};M=!0;var p=20,r=[NaN,NaN,null],k=b[0],F=b[1],c=k.header,u=Math.min(c.lo1,c.lo2),n=Math.min(c.la1,c.la2),t=Math.max(c.lo1,c.lo2),m=Math.max(c.la1,c.la2),x=500,q=(t-u)/(m-n)*x,y=d3.scale.linear().domain([0,q]).range([u,t]),z=d3.scale.linear().domain([0,x]).range([n,m]),w=document.createElement("canvas");w.width=q;w.height=x;var v=w.getContext("2d");N=e.entities.add({rectangle:{coordinates:Cesium.Rectangle.fromDegrees(60,10,150,60),height:1E5,material:new Cesium.ImageMaterialProperty({image:w,color:Cesium.Color.fromBytes(255,255,255,Cesium.Color.floatToByte(.99))})}});for(var D=c.lo1,E=Math.max(c.la1,c.la2),I=c.dx,L=c.dy,n=c.nx,t=c.ny,A=[],u=m=0;u<t;u++){for(var G=[],c=0;c<n;c++,m++)G[c]=[k.data[m],F.data[m]];A[u]=G}for(var H=[],u=0;u<x;u++){k=[];for(c=0;c<q;c++)F=f(c,u),k[c]=F;H[u]=k}for(var B=function(a,b){for(var c=[],d=170;0<=d;d-=a)c.push("rgba("+d+", "+d+", 255, 1)");c.indexFor=function(a){return Math.floor(Math.min(a,b)/b*(c.length-1))};return c}(10,17),C=B.map(function(){return[]}),f=Math.round(10*q),J=function(a){var b,c,d=0;do b=Math.round(_.random(0,q)),c=Math.round(_.random(0,x));while(null===h(b,c)[2]&&30>d++);a.x=b;a.y=c;return a},K=[],c=0;c<f;c++)K.push(J({age:_.random(0,p)}));v.lineWidth=1;v.fillStyle="rgba(0, 0, 0, 0.97)";(function Ia(){g();d();_.extend(N.rectangle.material.image,{_value:w.toDataURL()});M&&setTimeout(Ia,100)})()}})}function ra(){N&&e.entities.contains(N)&&(M=!1,e.entities.remove(N));J&&e.entities.contains(J)&&e.entities.remove(J)}function sa(a){"windTemp"==a?(ea(),K.show=!1,E.hide(),q&&e.dataSources.remove(q),Ga()):"interpolation"==a?(ea(),K.show=!1,E.hide(),ra(),Ea()):(ra(),q&&e.dataSources.remove(q))}d3.select(P).style({width:window.screen.width+"px",height:window.screen.height+"px"});P=P.replace("#","");var W,ta,fa;W="satelliteMapUrl"in t?new Cesium.UrlTemplateImageryProvider({url:t.satelliteMapUrl,maximumLevel:7}):void 0;ta="streetMapUrl"in t?new Cesium.UrlTemplateImageryProvider({url:t.streetMapUrl,maximumLevel:7}):Cesium.createOpenStreetMapImageryProvider({url:"https://a.tile.openstreetmap.org/"});fa="terrainMapUrl"in t?new Cesium.CesiumTerrainProvider({url:t.terrainMapUrl}):new Cesium.VRTheWorldTerrainProvider({url:"http://www.vr-theworld.com/vr-theworld/tiles1.0.0/73/",credit:"Terrain data courtesy VT M\u00c4K"});var e=new Cesium.Viewer(P,{animation:!1,timeline:!1,vrButton:!1,fullscreenButton:!0,geocoder:!1,homeButton:!1,infoBox:!0,sceneModePicker:!0,selectionIndicator:!1,navigationHelpButton:!1,baseLayerPicker:!1,imageryProvider:W,terrainExaggeration:40,useDefaultRenderLoop:!0,targetFrameRate:void 0,showRenderLoopErrors:!1,automaticallyTrackDataSourceClocks:!0,contextOptions:void 0,sceneMode:Cesium.SceneMode.SCENE3D,mapProjection:new Cesium.WebMercatorProjection,dataSources:new Cesium.DataSourceCollection});e.terrainProvider=fa;e._cesiumWidget._creditContainer.style.display="none";d3.select(".cesium-viewer-infoBoxContainer").style("display","none");e.scene.screenSpaceCameraController.minimumZoomDistance=5E4;e.scene.screenSpaceCameraController.maximumZoomDistance=5E7;e.scene.screenSpaceCameraController._minimumZoomRate=5E4;var C=e.imageryLayers;satelliteLayer=W?new Cesium.ImageryLayer(W):C.get(0);satelliteLayer.name="\u536b\u661f+\u5730\u5f62";streetLayer=new Cesium.ImageryLayer(ta);streetLayer.name="\u5730\u56fe";var l={overlayType:"defaultOverlay"in t?t.defaultOverlay:"pm2_5",dataServerAddr:Z,imageServerAddr:wa,color:"\u6807\u51c6",realHeight:"realHeight"in t?t.realHeight:!0,time:moment.utc("2017-02-25 23:00:00"),mapType:"satelliteMap"},aa=Array(15),A=[],H=[],B,G,X,Y,p=products.productsFor(l);ja(p.levelNum);var I,Q=!1,ma=function(){p.paths().forEach(function(a,b){(function(a,b){var d=l.time.utc().format("YYYY-MM-DD_HH")+"-";Cesium.loadJson(l.dataServerAddr+"/data/pollute/2015052506/"+d+a).then(function(a){a=p.data(a);for(var d=5E4*b,f=ya(b).entities,e=p.valueRange.min,g=ca(),h=0;h<a.data.length;h++){var c=a.data[h];if(c>=e){l.realHeight&&(d=100*aa[b][h]);var u=A[h],n=H[h];f.add({value:{value:c,lon:n,lat:u},name:"",position:Cesium.Cartesian3.fromDegrees(n,u,d),box:{dimensions:new Cesium.Cartesian3(26E3,27E3,27E3),material:g(c)}})}}}).otherwise(function(a){console.log(a)})})(a,b)})},pa,qa,T,v=new Cesium.CustomDataSource("stationList");e.dataSources.add(v);v.show=!1;var z=new Cesium.CustomDataSource("allCitiesList");e.dataSources.add(z);z.show=!1;var D=new Cesium.CustomDataSource("capitalCityList");e.dataSources.add(D);D.show=!1;var da=d3.scale.linear().domain([0,50,100,200,300,400,500,1E3]).range("#1e90ff #00ff00 #ffff00 #ff9900 #ff0000 #4c1130 #312129 #000000".split(" "));(function(){Cesium.GeoJsonDataSource.load("/data/two_provinces-topo.json").then(function(a){T=a;e.dataSources.add(T);a=T.entities.values;for(var b=0;b<a.length;b++){var d=a[b];d.name=d.properties.ID;d.properties["\u5730\u57df"]="\u4eac\u6d25\u5180";delete d.properties.ID;d.type="province";d.stationLoded=!1;d.polygon.material=Cesium.Color.fromAlpha(Cesium.Color.packedLength,.01);d.polygon.outline=!1}}).otherwise(function(a){window.alert(a)})})();var V,ga=function(a){V=e.camera.positionCartographic.height;2E6<V?(v.show=!1,z.show=!1,D.show=!0):(2E5<V?(v.show=!1,z.show=!0):(0==v.show&&(oa(U),v.show=!0),z.show=!1),D.show=!1)},w,m=new Cesium.ScreenSpaceEventHandler(e.scene.canvas),E=function(){function a(){m.selectAll(".polluteText").remove();l.selectAll("path").remove();l.selectAll("rect").remove()}function b(){f.attr("style","display:block")}var d=null,e={"PM2.5":d3.rgb(0,0,255),PM10:d3.rgb(120,63,4),SO2:d3.rgb(255,0,51),NO2:d3.rgb(51,153,0),CO:d3.rgb(51,0,102),O3:d3.rgb(255,153,0)},h="PM2.5 PM10 SO2 NO2 CO O3".split(" "),f=d3.select("#histogram").append("svg").attr("width",400).attr("height",300).append("g").attr("transform","translate(55,10)"),l=f.append("g");f.append("g").attr("class","x axis").attr("transform","translate(0,250)");f.append("g").attr("class","y axis");var m=f.append("g").attr("id","polltext"),r=f.append("text").attr("class","x label").attr("text-anchor","end").attr("x",55).attr("y",285),k=f.append("text").attr("class","y label").attr("text-anchor","end").attr("y",-45).attr("x",-250/3).attr("dy",".75em").attr("transform","rotate(-90)"),p=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return"\x3cstrong\x3e\u6570\u91cf:\x3c/strong\x3e \x3cspan style\x3d'color:red'\x3e"+a.num+"\x3c/span\x3e"});f.call(p);return{updateSTFigure:function(c){b();"stationTrend"!=d&&(d="stationTrend",a(),r.text("\u8fc7\u53bb24\u5c0f\u65f6"),k.text("IAQI"),m.selectAll(".polluteText").data(h).enter().append("text").attr("class","polluteText").attr("text-anchor","end").attr("x",function(a,b){return 95+35*b}).attr("y",285).attr("fill",function(a){return e[a].toString()}).text(function(a){return a}));var g=d3.time.scale().domain(_.map(d3.extent(_.pluck(c,"time")),function(a){return new Date(a)})).range([0,315]),n=d3.svg.axis().scale(g).ticks(7).orient("bottom");f.select(".x.axis").transition().duration(100).ease("linear").call(n);var n=1.1*_.max([_.max(_.pluck(c,"pm25")),_.max(_.pluck(c,"pm10")),_.max(_.pluck(c,"o3"))]),p=d3.scale.linear().domain([0,n]).range([250,0]),n=d3.svg.axis().scale(p).orient("left");f.select(".y.axis").transition().duration(500).ease("linear").call(n);c=[{name:"PM2.5",pdata:_.map(c,function(a){return[a.time,a.pm25]})},{name:"PM10",pdata:_.map(c,function(a){return[a.time,a.pm10]})},{name:"SO2",pdata:_.map(c,function(a){return[a.time,a.so2]})},{name:"NO2",pdata:_.map(c,function(a){return[a.time,a.no2]})},{name:"CO",pdata:_.map(c,function(a){return[a.time,a.co]})},{name:"O3",pdata:_.map(c,function(a){return[a.time,a.o3]})}];var q=d3.svg.line().x(function(a){return g(new Date(a[0]))}).y(function(a){return p(a[1])}).interpolate("basis");c=l.selectAll("path").data(c,function(a){return a.name});c.enter().append("path").attr("d","M0,250 H315").attr("fill","none").attr("stroke-width",3).attr("stroke",function(a){return e[a.name]}).attr("name",function(a){return a.name}).transition().duration(1E3).ease("linear").attr("d",function(a){return q(a.pdata)});c.transition().duration(1E3).ease("linear").attr("d",function(a){return q(a.pdata)})},updateALFigure:function(c){b();var e=d3.scale.ordinal().domain("\u4f18 \u826f \u8f7b\u5ea6 \u4e2d\u5ea6 \u91cd\u5ea6 \u4e25\u91cd".split(" ")).rangeBands([0,315],.1);if("analysis"!=d){d="analysis";a();var g=d3.svg.axis().scale(e).orient("bottom");f.select(".x.axis").call(g);r.text("\u6c61\u67d3\u7b49\u7ea7");k.text("\u6570\u91cf")}var g=1.2*d3.max([c["\u4f18"],c["\u826f"],c["\u8f7b\u5ea6"],c["\u4e2d\u5ea6"],c["\u91cd\u5ea6"],c["\u4e25\u91cd"]]),h=d3.scale.linear().domain([0,g]).range([250,0]),g=d3.svg.axis().scale(h).orient("left");f.select(".y.axis").transition().duration(100).ease("linear").call(g);var g=[],m;for(m in c)g.push({level:m,num:c[m]});c=l.selectAll(".bar").data(g);c.enter().append("rect").attr("class","bar").attr("x",function(a){return e(a.level)}).attr("width",e.rangeBand()).attr("y",250).attr("height",0).on("mouseover",p.show).on("mouseout",p.hide).transition().duration(300).ease("linear").attr("y",function(a){return h(a.num)}).attr("height",function(a){return 250-h(a.num)});c.transition().duration(300).ease("linear").attr("y",function(a){return h(a.num)}).attr("height",function(a){return 250-h(a.num)})},clearFigure:a,figureShow:b,hide:function(){f.attr("style","display:none")}}}(),U,K,y=new Cesium.Rectangle,ua=new Cesium.Cartesian3,L=new Cesium.Cartographic;new Cesium.Cartographic;var O=new Cesium.Cartographic,ha=!1,ia=!1,Ja=function(){ia=!0;e.scene.screenSpaceCameraController.enableInputs=!1},va=function(){ha=ia=!1;e.scene.screenSpaceCameraController.enableInputs=!0},Ka=function(a){ia&&(ua=e.camera.pickEllipsoid(a.endPosition,e.scene.globe.ellipsoid))&&(L=Cesium.Cartographic.fromCartesian(ua,Cesium.Ellipsoid.WGS84),ha?(y.east=Math.max(L.longitude,O.longitude),y.west=Math.min(L.longitude,O.longitude),y.north=Math.max(L.latitude,O.latitude),y.south=Math.min(L.latitude,O.latitude),K.show=y.east!==y.west||y.north!==y.south,a=Da(y),a=Ca(a),E.updateALFigure(a)):(Cesium.Cartographic.clone(L,O),ha=!0))};Z={coordinates:new Cesium.CallbackProperty(function(){return y},!1),height:500,material:Cesium.Color.fromAlpha(Cesium.Color.DARKVIOLET,.2),outline:!0,outlineColor:Cesium.Color.BLACK,outlineWidth:3};K=e.entities.add({type:"selector",selectable:!1,show:!1,rectangle:Z});var Fa=d3.scale.linear().domain([0,.125,.375,.625,.875,1]).range("#000083 #003caa #05ffff #ffff00 #fa0000 #800000".split(" ")),q,N,J,M;return{getConfig:function(){return l},setFocus:function(a,b,d){e.camera.setView({destination:Cesium.Cartesian3.fromDegrees(a,b,d)});e.scene.morphComplete.addEventListener(function(){setTimeout(function(){e.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(a,b,d)})},1E3)})},buildImagePath:function(a,b){return l.imageServerAddr+"overlay\x3d"+l.overlayType+"\x26verticaltype\x3d"+a+"\x26time\x3d"+l.time.format("YYYY-MM-DD_HH")+"\x26num\x3d"+b},setLonEntPosition:function(a){X.wall.positions=Cesium.Cartesian3.fromDegreesArray([B[0][a],10,B[193][a],53])},setLatEntPosition:function(a){Y.wall.positions=Cesium.Cartesian3.fromDegreesArray([73,G[a][0],135,G[a][0]])},changeMap:function(a){"streetMap"==a?na():"satelliteMap"!=l.mapType&&(l.mapType="satelliteMap",e.terrainProvider=fa,C.remove(streetLayer,!1),C.add(satelliteLayer),l.realHeight=!0);R()},getPixColorScale:ca,reloadData:R,setDate:function(a){l.time.add(a,"h");R();Q&&(e.dataSources.remove(I),la())},renderColorScale:function(a,b){l.color=a;var d=colortable.getColorScale(a),e=d?d:p.colorScale,h=d?{min:0,max:1}:p.valueRange,f=b.node(),m=f.width,d=f.height,f=f.getContext("2d"),q=m-1;f.clearRect(0,0,m,d);for(var m=h.min,h=h.max,r=0;r<=q;r++){var k=d3.rgb(e(r/q*(h-m)+m));f.fillStyle="rgb("+k.r+","+k.g+","+k.b+")";f.fillRect(r,0,1,d)}b.on("mousemove",function(){var a=d3.mouse(this)[0],c=p.valueRange.min,a=(Math.max(0,Math.min((Math.round(a)-2)/(q-2),1))*(p.valueRange.max-c)+c).toFixed(2);b.attr("title",a+" "+p.units[0].label)})},recolor:function(){var a=ca();ba().forEach(function(b){b.entities.values.forEach(function(b){b.box.material.color=a(b.value.value)})})},setVerticalShow:function(){Y.show=!0;X.show=!0},setVerticalHide:function(){Y.show=!1;X.show=!1},setShowRange:function(a){var b=a.latRange,d=a.lonRange,e=a.heightRange,h=a.valRange;"temp"==l.overlayType&&(h=[parseFloat(h[0])+273.15,parseFloat(h[1])+273.15]);ba().forEach(function(a){var f=parseInt(a.name.split("-")[1])+1;f>=e[0]&&f<=e[1]?(a.show=!0,a=a.entities,a.suspendEvents(),a.values.forEach(function(a,e,f){e=a.value.lat;f=a.value.lon;var g=a.value.value,c=!0;if(e<=b[0]||e>=b[1])c=!1;if(f<=d[0]||f>=d[1])c=!1;if(g<=h[0]||g>=h[1])c=!1;a.show=c?!0:!1}),a.resumeEvents()):a.show=!1})},setOverlay:function(a){l.overlayType=a;p=products.productsFor(l)},getOverlay:function(){return p},showPBLH:function(){Q=!0;la()},hidePBLH:function(){Q=!1;e.dataSources.remove(I)},start:function(){xa().then(function(){var a="defaultLatEnt"in t?t.defaultLatEnt:100;Y=e.entities.add({show:!1,name:"vertical-lat",wall:{positions:Cesium.Cartesian3.fromDegreesArray([73,G[a][0],135,G[a][0]]),maximumHeights:[2E5,2E5],minimumHeights:[0,0],material:Cesium.Color.fromAlpha(Cesium.Color.DEEPSKYBLUE,.7)}});a="defaultLonEnt"in t?t.defaultLonEnt:119;X=e.entities.add({show:!1,name:"vertical-long",wall:{positions:Cesium.Cartesian3.fromDegreesArray([B[0][a],10,B[193][a],53]),maximumHeights:[2E5,2E5],minimumHeights:[0,0],material:Cesium.Color.fromAlpha(Cesium.Color.DEEPSKYBLUE,.7)}});ma()})},changeLayer:sa,enableMonitor:function(){ka();d3.select(".cesium-viewer-infoBoxContainer").style("display","block");na();za();M=!0;e.camera.moveEnd.addEventListener(ga);m.setInputAction(Aa,Cesium.ScreenSpaceEventType.LEFT_CLICK);m.setInputAction(Ba,Cesium.ScreenSpaceEventType.MOUSE_MOVE);m.setInputAction(Ja,Cesium.ScreenSpaceEventType.LEFT_DOWN,Cesium.KeyboardEventModifier.SHIFT);m.setInputAction(va,Cesium.ScreenSpaceEventType.LEFT_UP,Cesium.KeyboardEventModifier.SHIFT);m.setInputAction(va,Cesium.ScreenSpaceEventType.LEFT_UP);m.setInputAction(Ka,Cesium.ScreenSpaceEventType.MOUSE_MOVE,Cesium.KeyboardEventModifier.SHIFT);ga()},disableMonitor:function(){d3.select(".cesium-viewer-infoBoxContainer").style("display","none");sa("none");ea();E.clearFigure();E.hide();M=K.show=!1;v.show=!1;z.show=!1;D.show=!1;e.camera.moveEnd.removeEventListener(ga);m.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);m.removeInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE);m.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOWN,Cesium.KeyboardEventModifier.SHIFT);m.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_UP,Cesium.KeyboardEventModifier.SHIFT);m.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_UP);m.removeInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE,Cesium.KeyboardEventModifier.SHIFT);R()}}};